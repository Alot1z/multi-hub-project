name: ğŸ“Š Update README Status

on:
  schedule:
    # Run every 10 minutes
    - cron: '*/10 * * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force status update'
        required: false
        default: false
        type: boolean

jobs:
  update-status:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.UPLOAD_PATH }}

      - name: ğŸ” Check Service Status
        id: check_status
        run: |
          echo "ğŸ” Checking all Multi-Hub services..."
          
          # Services to check
          declare -A services=(
            ["launcher"]="https://alot1z.github.io"
            ["hub-ui"]="https://hub-uii.netlify.app"
            ["ipa-builder"]="https://ipa-builder.netlify.app"
            ["printer-builder"]="https://printer-builder.netlify.app"
            ["game-builder"]="https://game-build.netlify.app"
            ["ai-models"]="https://ai-modelss.netlify.app"
            ["bolt-new"]="https://bolt-new-multi-hub.netlify.app"
            ["qodo-gen"]="https://qodo-gen-multi-hub.netlify.app"
            ["api-gateway"]="https://api-alot1z-github-io.netlify.app"
          )
          
          online_count=0
          total_count=${#services[@]}
          status_lines=""
          
          for service in "${!services[@]}"; do
            url="${services[$service]}"
            echo "Checking $service at $url..."
            
            # Check service status with timeout
            if curl -s --max-time 10 --head "$url" | head -n 1 | grep -q "200\|301\|302"; then
              status="ğŸŸ¢ Live"
              ((online_count++))
            else
              status="ğŸ”´ Offline"
            fi
            
            # Format service name
            case $service in
              "launcher") icon="ğŸŒ"; name="Launcher" ;;
              "hub-ui") icon="ğŸ›ï¸"; name="Hub UI" ;;
              "ipa-builder") icon="ğŸ“±"; name="IPA Builder" ;;
              "printer-builder") icon="ğŸ–¨ï¸"; name="Printer Builder" ;;
              "game-builder") icon="ğŸ®"; name="Game Builder" ;;
              "ai-models") icon="ğŸ¤–"; name="AI Models" ;;
              "bolt-new") icon="âš¡"; name="Bolt.new Clone" ;;
              "qodo-gen") icon="ğŸ”§"; name="Qodo Gen" ;;
              "api-gateway") icon="ğŸ”—"; name="API Gateway" ;;
            esac
            
            status_lines+="$icon **$name** â€¢ $status â€¢ [$url]($url)  "$'\n'
          done
          
          # Calculate percentage
          percentage=$(( (online_count * 100) / total_count ))
          
          # Set outputs
          echo "online_count=$online_count" >> $GITHUB_OUTPUT
          echo "total_count=$total_count" >> $GITHUB_OUTPUT
          echo "percentage=$percentage" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          
          # Save status lines to file
          echo "$status_lines" > /tmp/status_lines.txt
          
          echo "ğŸ“Š Status Check Complete:"
          echo "Online: $online_count/$total_count ($percentage%)"

      - name: ğŸ“ Update README Status
        run: |
          online_count="${{ steps.check_status.outputs.online_count }}"
          total_count="${{ steps.check_status.outputs.total_count }}"
          percentage="${{ steps.check_status.outputs.percentage }}"
          timestamp="${{ steps.check_status.outputs.timestamp }}"
          
          # Read status lines
          status_lines=$(cat /tmp/status_lines.txt)
          
          # Determine overall status
          if [ "$percentage" -eq 100 ]; then
            overall_status="ğŸŸ¢ All Systems Operational"
            status_color="green"
          elif [ "$percentage" -ge 70 ]; then
            overall_status="ğŸŸ¡ Partial Outage"
            status_color="yellow"
          else
            overall_status="ğŸ”´ Major Outage"
            status_color="red"
          fi
          
          # Create status badge URL
          badge_url="https://img.shields.io/badge/System%20Status-${percentage}%25%20Online-${status_color}?style=for-the-badge"
          
          # Create new status section
          cat > /tmp/new_status.md << EOF
          ## ğŸ“Š **Live System Status**
          
          ![System Status](${badge_url})
          
          **${overall_status}** â€¢ ${online_count}/${total_count} services online (${percentage}%) â€¢ *Last updated: ${timestamp}*
          
          ### ğŸ¯ **Service Status:**
          
          ${status_lines}
          
          **ğŸ“Š [View Full Status Dashboard â†’](https://alot1z.github.io/deploy-status)**
          
          ---
          EOF
          
          # Backup original README
          cp README.md README.md.backup
          
          # Remove old status section if exists
          sed -i '/## ğŸ“Š \*\*Live System Status\*\*/,/^---$/d' README.md
          
          # Find insertion point (after the platform architecture section)
          if grep -q "## ğŸš€ \*\*Live Platforms\*\*" README.md; then
            # Insert before Live Platforms section
            sed -i '/## ğŸš€ \*\*Live Platforms\*\*/i\
          '"$(cat /tmp/new_status.md)"'' README.md
          else
            # Insert after header if Live Platforms not found
            sed -i '/^---$/a\
          '"$(cat /tmp/new_status.md)"'' README.md
          fi
          
          echo "âœ… README.md updated with live status"

      - name: ğŸ’¾ Commit Status Update
        run: |
          git config user.name "Multi-Hub Status Bot"
          git config user.email "status-bot@alot1z.github.io"
          
          git add README.md
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No status changes to commit"
          else
            online_count="${{ steps.check_status.outputs.online_count }}"
            total_count="${{ steps.check_status.outputs.total_count }}"
            percentage="${{ steps.check_status.outputs.percentage }}"
            
            git commit -m "ğŸ“Š Auto-update system status: ${online_count}/${total_count} online (${percentage}%)" \
                       -m "Timestamp: ${{ steps.check_status.outputs.timestamp }}" \
                       -m "Automated status check via GitHub Actions"
            
            git push origin main
            echo "âœ… Status update committed and pushed"
          fi

      - name: ğŸ”” Status Summary
        run: |
          echo "ğŸ‰ README Status Update Complete"
          echo "================================"
          echo "Online Services: ${{ steps.check_status.outputs.online_count }}/${{ steps.check_status.outputs.total_count }}"
          echo "System Health: ${{ steps.check_status.outputs.percentage }}%"
          echo "Last Updated: ${{ steps.check_status.outputs.timestamp }}"
          echo ""
          echo "ğŸ“Š View live status: https://alot1z.github.io/deploy-status"
          echo "ğŸ“š View README: https://github.com/Alot1z/multi-hub-project/blob/main/README.md"
